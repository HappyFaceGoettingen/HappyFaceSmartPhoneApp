angular.module("hf.FacWebservice",[]).factory("FacWebservice",["FacInstances","FacRequest","FacUIVariables","FacPopup","$timeout",function(e,t,n,r,i){function c(e){s=e}function h(){a=[];o=[];u=[];f=[]}function p(){var e=l().webServiceUrl;if(e.charAt(e.length-1)=="/"){return e}else{return e+"/"}}function d(){return p()+"query_result.json"}function v(){n.beginLoading(false);n.setIsLoading(true)}function m(){i(function(){n.setIsLoading(false);n.stopLoading(false);n.setTimeOutIsGreyedOut(e.getLastActiveInstance().lastRefreshed)},800)}function g(){v();var e=p()+"db_table_list.py";t.Query(e).then(function(e){for(var t=0;t<e.data.length;++t){if(e.data[t].module_name==s.name){o.push({table_name:e.data[t].table_name,table_columns:e.data[t].table_columns})}}y()},function(){console.log("error while getting mapping");r.showPopupByName("noInternetOrServerWrong");m()})}function y(){var e=p()+"db_backend.py?data=SELECT+hf_runs.time,";var t=new Date;var n=new Date(t.getTime()+ -45*6e4);var r=x(n);var i=x(t);for(var s=0;s<o.length;++s){var a=e;for(var f=0;f<o[s].table_columns.length;++f){a+="+"+o[s].table_name+"."+o[s].table_columns[f]+","}a=a.slice(0,-1);a+="+FROM+hf_runs+INNER+JOIN+"+o[s].table_name+"+ON+hf_runs.id+=+"+o[s].table_name+".id"+"+WHERE+'"+r+"'"+"+<+hf_runs.time+AND+'"+i+"'+>+hf_runs.time%3B+";u[s]=a}b()}function b(){function n(){if(e<u.length){t.Query(u[e]).then(function(){t.Query(d()).then(function(t){a.push(t.data[0]);e++;n()},function(){console.log("error while downloading query result, iteration "+e);r.showPopupByName("noInternetOrServerWrong");m()})},function(){console.log("error while queueing, iteration "+e);r.showPopupByName("noInternetOrServerWrong");m()})}else{w()}}var e=0;n()}function w(){for(var e=0;e<a.length;++e){var t=a[e].table_columns.split(",");var n=a[e].content;var r=[];for(var i=0;i<n.length;++i){var s={};for(var o=0;o<t.length;++o){s[t[o]]=n[i][o]}r.push(s)}a[e]=r}E()}function E(){for(var e=0;e<a.length;++e){var t=[];for(var n=0;n<a[e].length;++n){var r=new Date(a[e][n]["hf_runs.time"].substring(0,19).replace(/-/g,"/"));t.push(r)}var i=0;for(n=1;n<t.length;n++){if(t[n]>t[i]){i=n}}if(a[e].length!=0){a[e]=a[e][i]}else{a[e]={}}}S()}function S(){f=[];for(var e=0;e<a.length;++e){var t={};t["name"]=o[e].table_name;if(!angular.equals({},a[e])){t["time"]=a[e]["hf_runs.time"].substring(0,16);t["content"]=[];angular.forEach(a[e],function(e,n){n=n.substring(n.indexOf(".")+1,n.length);if(n!="time"){t["content"].push({column_name:n,column_value:e})}});f.push(t)}}if(f.length==0){r.showPopupByName("webserviceReturnedEmpty")}m()}function x(e){var t=e.getMonth()+1;if(t.toString().length==1){t="0"+t}var n=e.getDate();if(n.toString().length==1){n="0"+n}var r=e.getHours();if(r.toString().length==1){r="0"+r}var i=e.getMinutes();if(i.toString().length==1){i="0"+i}return e.getFullYear()+"-"+t+"-"+n+"+"+r+":"+i+":00.000000"}var s={};var o=[];var u=[];var a=[];var f=[];var l=function(){return e.getLastActiveInstance()};return{setActiveModule:function(e){c(e)},getActiveModule:function(){return s},setTableContent:function(){h();g()},getTableContent:function(){return f}}}])