angular.module("hf.FacInstances",[]).factory("FacInstances",["FacUIVariables","FacRequest","FacPopup","$timeout","$q",function(e,t,n,r,i){function a(e){if(e==-1){o=[];window.localStorage.removeItem("lastActiveInstance");return}o=s[e];window.localStorage["lastActiveInstance"]=e}function f(){window.localStorage.setItem("instances",angular.toJson(s))}function l(r,i){var o={title:r.title,url:r.url,webServiceUrl:r.webServiceUrl};o.usingWebservice=o.webServiceUrl?true:false;e.beginLoading(i);t.Query(o.url).then(function(t){if(t.data.indexOf("<happyface>")>-1){var r=$.xml2json(t.data);var u;for(u=0;u<r.category.length;++u){r.category[u].status=parseFloat(r.category[u].status)}o.categories=r;o.lastRefreshed=new Date;s.push(o);if(i){a(s.length-1)}f();e.stopLoading(i);e.setTimeOutIsGreyedOut(o.lastRefreshed)}else{e.stopLoading(i);n.showPopupByName("invalidUrl")}},function(){e.stopLoading(i);n.showPopupByName("errorWhileAdding",o.title)})}function c(){t.cancel();if(o.length!=0){e.setIsLoading(true);e.beginLoading(false);t.Query(o.url).then(function(t){var n=$.xml2json(t.data);var i;for(i=0;i<n.category.length;++i){n.category[i].status=parseFloat(n.category[i].status)}o.categories=n;o.lastRefreshed=new Date;f(s);r(function(){e.setTimeOutIsGreyedOut(o.lastRefreshed);e.setIsLoading(false);e.stopLoading(false)},800)},function(t){if(t.data===null){console.log("previous refresh has been canceled")}else{console.log("error while refreshing");r(function(){e.setIsLoading(false);e.stopLoading(false);n.showPopupByName("noInternet")},800)}})}else{n.showPopupByName("errorWhileRefreshing")}}function h(){if(navigator.connection.type!=Connection.NONE&&o.length!=0){var e=o.lastRefreshed;var t=new Date(e);var n=new Date;if(n.getTime()-t.getTime()>12e4){r(function(){c()},400)}}}function p(){while(s.length!=0){d(0)}a(-1);l({title:"CMS T1 Production Monitoring",url:"http://ekphappyface.physik.uni-karlsruhe.de/~happyface/cmst1prodmon/webpage/?action=getxml"},false);l({title:"Belle",url:"http://ekphappyface.physik.uni-karlsruhe.de/HappyFace/belle/category?action=getxml"},false);l({title:"KIT T3",url:"http://ekphappyface.physik.uni-karlsruhe.de/~happyface/t3-kit/webpage/?action=getxml"},false);l({title:"KIT T1",url:"http://ekphappyface.physik.uni-karlsruhe.de/~happyface/gridka/webpage/?action=getxml"},false);l({title:"GoeGrid",url:"http://happyface-goegrid.gwdg.de/category?action=getxml",webServiceUrl:"http://happyface-goegrid.gwdg.de/webservice/"},false)}function d(e){s.splice(s.indexOf(e),1);f(s)}function v(){var n=i.defer();t.Query(o.url).then(function(t){var r=$.xml2json(t.data);var i;for(i=0;i<r.category.length;++i){r.category[i].status=parseFloat(r.category[i].status)}o.categories=r;o.lastRefreshed=new Date;f(s);e.setTimeOutIsGreyedOut(o.lastRefreshed);n.resolve()},function(){n.reject("could not query that url")});return n.promise}var s=[];var o=[];var u=window.localStorage["instances"];if(u){s=angular.fromJson(u)}if(window.localStorage["lastActiveInstance"]){o=s[parseInt(window.localStorage["lastActiveInstance"])]}return{all:function(){return s},saveInstances:function(e){f(e)},getLastActiveInstance:function(){return o},setLastActiveInstance:function(e){a(e)},createInstance:function(e,t){l(e,t)},refresh:function(){c()},conditionalRefresh:function(){h()},setInstancesToDefault:function(){p()},removeInstance:function(e){d(e)},lightweightRefresh:function(){return v()}}}])